# Decision-to-Production MVP Design

## Overview

MVP de plataforma colaborativa donde equipos internos describen features y AI las construye con human-in-the-loop approval, diferenciÃ¡ndose de v0/Lovable por la colaboraciÃ³n estructurada y el flujo de aprobaciÃ³n explÃ­cito.

## Target User (MVP)

Internal team workflow:
- Product/Business users describen features
- Developers revisan y aprueban PRs
- Sin cliente externo en el loop (viene post-MVP)

## Core Flow

```
IDLE â†’ PLANNING â†’ PLAN_REVIEW â†’ BUILDING â†’ READY
```

### Estados

**IDLE**: Usuario escribe request en el chat.

**PLANNING**: El AI analiza el repo y genera un plan. Usuario ve "Analizando..." con indicador de progreso.

**PLAN_REVIEW**: El AI presenta el plan en lenguaje humano:
- QuÃ© va a cambiar (bullets claros)
- Archivos que va a tocar
- Riesgos o consideraciones (si hay)

Opciones del usuario:
- **"Looks good, build it"** â†’ pasa a BUILDING
- **"Adjust this..."** â†’ feedback, vuelve a PLANNING
- **"Cancel"** â†’ vuelve a IDLE

**BUILDING**: El agente ejecuta el plan aprobado. Usuario ve:
- Archivos siendo modificados en tiempo real
- Preview actualizÃ¡ndose
- Puede cancelar si algo va mal

**READY**: Agente terminÃ³. Usuario ve:
- Preview funcional
- "Create PR" o "Iterate more"

## ColaboraciÃ³n

### Group Chat Model
- La sesiÃ³n es un group chat donde cualquier miembro del workspace puede escribir
- El AI es un participante mÃ¡s que responde a los requests
- Sin roles formales en MVP - cualquier miembro puede aprobar plan o crear PR

### @Mentions
- `@nombre` para mencionar miembros del workspace
- Autocomplete cuando escribes `@`
- NotificaciÃ³n al usuario mencionado (in-app + email)

### Realtime + Async
- **Realtime**: Presence indicators, typing indicators, cambios del AI en vivo (via Ably)
- **Async**: @mentions notifican, usuario ve contexto cuando entra a la sesiÃ³n

## Arquitectura de EjecuciÃ³n

```
Next.js Backend
       â”‚
       â–¼
Claude Agent SDK
       â”‚
       â”œâ”€â”€ Tools:
       â”‚   â”œâ”€â”€ read_file(path)
       â”‚   â”œâ”€â”€ write_file(path, content)
       â”‚   â”œâ”€â”€ run_command(cmd)
       â”‚   â”œâ”€â”€ list_files(dir)
       â”‚   â””â”€â”€ create_pr(title, description)
       â”‚
       â–¼
Sandbox (Daytona)
       â”‚
       â”œâ”€â”€ Repo clonado
       â”œâ”€â”€ Dev server corriendo
       â””â”€â”€ Preview URL
```

### Flujo TÃ©cnico
1. Usuario aprueba plan
2. Backend invoca Claude Agent SDK con plan + repo context
3. Agente usa tools para modificar archivos en sandbox
4. Cada write_file actualiza el preview (hot reload)
5. Cuando termina, backend crea PR via GitHub API

### Skills (Post-MVP)
- Para MVP: solo contexto del repo inyectado automÃ¡ticamente
- Post-MVP: UI para agregar skills, skills como acciones invocables

## GitHub Integration

### PR Flow
Cuando usuario hace click en "Create PR":

1. Crear branch desde main: `lumlabs/session-{sessionId}`
2. Commit cambios del sandbox a ese branch
3. Crear PR via GitHub API:
   - TÃ­tulo: nombre de la sesiÃ³n o generado del plan
   - DescripciÃ³n: resumen del plan + link a sesiÃ³n
   - Labels: `lumlabs`, `ai-generated`

4. Usuario ve confirmaciÃ³n con link directo al PR

### PR Description Template
```markdown
## Summary
{Resumen del plan aprobado}

## Changes
- {Lista de archivos modificados}

## Session
[View in LumLabs]({url a la sesiÃ³n})

---
Generated by LumLabs
```

## UI Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LumLabs   workspace-name                    [Participants] [â‹¯] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Session 1 âœ•] [Session 2 âœ•] [+]                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚                                   â”‚
â”‚        PREVIEW              â”‚            CHAT                   â”‚
â”‚                             â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   Messages...                    â”‚
â”‚   â”‚                   â”‚     â”‚                                   â”‚
â”‚   â”‚   Live Preview    â”‚     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚   (iframe)        â”‚     â”‚   â”‚ ğŸ¤– Plan Card            â”‚    â”‚
â”‚   â”‚                   â”‚     â”‚   â”‚ [Approve] [Adjust]      â”‚    â”‚
â”‚   â”‚                   â”‚     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                                   â”‚
â”‚                             â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   [â†» Refresh] [â†— Open]      â”‚   â”‚ Type message... @mention    â”‚â”‚
â”‚                             â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Componentes Clave
- **Session Tabs**: MÃºltiples sesiones como tabs
- **Preview Panel**: iframe con URL del sandbox, hot reload
- **Chat Panel**: Messages + input con @mentions
- **PlanCard**: Muestra plan con botones Approve/Adjust
- **BuildingIndicator**: Progreso de archivos siendo modificados
- **ReadyCard**: BotÃ³n Create PR

## Data Model (Ajustes)

### Session - agregar status
```typescript
status: 'idle' | 'planning' | 'plan_review' | 'building' | 'ready' | 'error'
```

### Message - agregar type
```typescript
type: 'user' | 'assistant' | 'plan' | 'system'
```

### Nueva tabla: session_members
```typescript
sessionMembers: {
  sessionId: string
  userId: string
  joinedAt: timestamp
  lastSeenAt: timestamp
}
```

### Nueva tabla: notifications
```typescript
notifications: {
  id: string
  userId: string
  sessionId: string
  messageId: string
  read: boolean
  createdAt: timestamp
}
```

## Roadmap al MVP

### Fase 1: Session Flow Core
- [ ] MÃ¡quina de estados de sesiÃ³n
- [ ] Claude Agent SDK con tools bÃ¡sicos
- [ ] Conectar sandbox Daytona con agente
- [ ] Preview iframe con URL del sandbox

### Fase 2: Plan Review UX
- [ ] PlanCard component
- [ ] Streaming del plan al chat
- [ ] LÃ³gica de aprobaciÃ³n/rechazo

### Fase 3: Building UX
- [ ] Streaming de progreso
- [ ] Hot reload del preview
- [ ] ReadyCard con botÃ³n Create PR

### Fase 4: GitHub PR
- [ ] Crear branch desde sandbox
- [ ] Commit cambios
- [ ] Crear PR via GitHub API
- [ ] Mostrar link al PR

### Fase 5: ColaboraciÃ³n
- [ ] @mentions con autocomplete
- [ ] Notificaciones
- [ ] MÃºltiples usuarios en mismo chat

## Post-MVP Roadmap

### v1.1 - Hooks & Integraciones
- Lifecycle hooks
- Webhooks externos (Slack)

### v1.2 - Skills System
- UI para skills por workspace
- Skills como acciones invocables
- Marketplace

### v1.3 - Risk-based Approvals
- ClasificaciÃ³n automÃ¡tica de riesgo
- Sugerencias de review
- Approvals diferenciados

### v1.4 - Roles & Permisos
- Roles: Product, Dev, Viewer
- Permisos por rol
- Client role

### v2.0 - Client-in-the-loop
- Invitar clientes externos
- Permisos limitados
- Flujo B2B completo

## Diferenciadores vs v0/Lovable

1. **Human-in-the-loop estructurado**: Plan approval explÃ­cito antes de construir
2. **ColaboraciÃ³n nativa**: Group chat con @mentions, no single-user
3. **PR-first output**: Siempre genera PR para audit trail
4. **Workspace context**: Skills y contexto del repo inyectados
5. **Multi-session tabs**: Trabajar en mÃºltiples features en paralelo
